<!--Sneaky HTML comment to persuade my text editor to highlight as HTML-->
{{define "content"}}
{{$SU := .SameUser}}
<head>
<script src=" https://cdn.jsdelivr.net/npm/macy@2.5.1/dist/macy.min.js "></script>
<title>{{.User.Username}}</title>
</head>
<body>
<div id="body">
	{{if $SU}}
	<dialog id="pfp-form-container">
		<p>Pick a new face!</p>
		<form id="pfp-form" action="/update_avatar" method="post" enctype="multipart/form-data">
		    <input type="file" name="pfp" accept="image/*">
			<input type="submit" value="Upload">
		</form>
	</dialog>

	<dialog id="delete-dialog">
		<form method="dialog">
			<p>You will permanently delete this gallery and its images FOREVER!!!!!!!!!!!!!!</p>
			<div>
				<button value="cancel">Wait, keep it!</button>
				<button value="confirm">Burninate it!</button>
				<input id="delete-gallery-id" type="hidden" name="gallery-id" value=""/>
			</div>
		</form>
	</dialog>
	{{end}}

	<div id="user-info">
		<div id="user-info-top">
			<img width="256" height="256" src="{{.User.Avatar}}" id="pfp">
			<div class="bio" id="bio-text"     {{if $SU}}onclick="toggleBioModifier('bio')"{{end}}>{{.User.Bio}}</div>
			{{if $SU}}<textarea class="modifiers bio" id="bio-modifier" onblur="updateBio('bio')" style="display: none">{{.User.Bio}}</textarea>{{end}}
		</div>
		<div id="displayname-text" {{if $SU}}onclick="toggleBioModifier('displayname')"{{end}}>{{.User.Displayname}}</div>
		{{if $SU}}<textarea class="modifiers" id="displayname-modifier" onblur="updateBio('displayname')" style="display: none">{{.User.Displayname}}</textarea>{{end}}
		<div id="username">@{{.User.Username}}</div>
	</div>

	<div id="img-grid">
		<div id="macy-container"></div>
		<div id="lbox">
			<div id="closeModal" onclick="toggleModal(undefined)">X</div>
			{{if $SU}}<div id="deleteGallery">Delete this gallery?</div>{{end}}
			<div id="lightbox-content">
				<div id="photo-container">
					<img id="photo" src="" class="photo">
				</div>
				<div id="sidebar">
					<div id="navigation-controls">
						<div class="change-slide" onclick="changeSlide(-1)"><<</div>
						<div class="change-slide" onclick="changeSlide(1)">>></div>
					</div>
					<div class="infobox gal-info">
						<p id="gallery-description">
						</p>
						<hr>
						<p id="gallery-upload-stamp">
						</p>
						<table class="infobox" id="img-exif">
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
<style>
#body {
	margin-left: auto;
	margin-right: auto;
	max-width: 90rem;
}

.gallery-thumb {
	padding: 1px;
	margin: 10px;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 8px 16px rgba(0, 0, 0, 0.2);
	transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.gallery-thumb:hover {
	transform: translateY(-4px);
	box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4), 0 16px 32px rgba(0, 0, 0, 0.3);
}


#lbox {
	position: fixed;
	z-index: 1;
	width: 100%;
	height: 100%;
	left: 0;
	top: 0;
	background-color: rgb(0, 0, 0, 0.8);
	display: flex;
	align-items: center;
	justify-content: center;
}

#lightbox-content {
	display: flex;
	width: 90%;
	height: 100vh;
	max-width: 1200px;
	background-color: white;
	border-radius: 8px;
	overflow: hidden;
	margin: auto;
}

#photo-container {
	flex: 1;
	display: flex;
	align-items: center;
	justify-content: center;
	background-color: #f5f5f5;
	position: relative;
	height: 100vh;
}

#photo-container img {
	max-width: 100%;
	max-height: 100%;
}

#sidebar {
	width: 300px;
	background-color: white;
	padding: 20px;
	overflow-y: auto;
	overflow-x: hidden;
	display: flex;
	flex-direction: column;
	gap: 15px;
	height: 100vh;
	word-wrap: break-word;
}

#navigation-controls {
	display: flex;
	gap: 10px;
	justify-content: center;
}

#pfp-form-container {
    background-color: white;
}

#closeModal {
	position: absolute;
	top: 10px;
	right: 10px;
	color: white;
	background-color: #4a4a4a;
	padding: 10px 15px;
	border-radius: 4px;
	cursor: pointer;
	z-index: 10;
}

#closeModal:hover {
	background-color: #2a2a2a;
}

#deleteGallery {
	position: absolute;
	bottom: 10px;
	right: 10px;
	color: white;
	background-color: #4a4a4a;
	padding: 10px 15px;
	border-radius: 4px;
	cursor: pointer;
	z-index: 10;
}

#deleteGallery:hover {
	background-color: #2a2a2a;
}

.change-slide {
	color: white;
	background-color: #4a4a4a;
	padding: 10px 15px;
	border-radius: 4px;
	cursor: pointer;
	text-align: center;
	flex: 1;
}

.change-slide:hover {
	background-color: #2a2a2a;
}

#img-grid {
	max-width: 90rem;
	margin: 0 auto 3rem;
}

#user-info {
	margin: 0 auto 3rem;
	width: 60rem;
}

#user-info-top {
	display:flex;
}

#infobox {
	background-color: gray;
	display: inline-block;
	width: 300px;
}

tr:nth-child(even) {
	background-color: light-gray;
}

.bio {
	flex-grow: 1;
    outline: dashed;
    overflow-wrap: break-word;
    white-space: pre-wrap;
}

.modifiers {
    resize: none;
}

#displayname-text {
	font-weight: bold;
	display: table;
}
</style>
<script type="text/javascript" defer>
let gals = JSON.parse({{.jsonGals}});

let thumbsBox = document.getElementById("macy-container");
let lightbox = document.getElementById("lbox");
lightbox.style.display = "none";

function createThumbnails() {
	while (thumbsBox.firstChild) {
		thumbsBox.removeChild(thumbsBox.firstChild);
	}
	let lastInserted = null;
	for (let gallery of gals) {
		let span = document.createElement("span");
		let el = document.createElement("img");
		//span.appendChild(el);
		el.src = gallery.Thumb;
		el.addEventListener("click", (e) => {
			toggleModal(gallery)
		})
		el.id = "photo"+gallery.Id;
		el.classList.add("gallery-thumb");
		lastInserted = thumbsBox.insertBefore(el, lastInserted);
	}
}
createThumbnails()

{{if $SU}} //for extra protections, dont include these in the templates for strangers (since this is all client side a user could add these back anyway, so its important to have server-side protections)
    //https://stackoverflow.com/a/54964425/12514997
    function formSubmit(sourceForm, endpoint) {
        var url = "";
        if (endpoint == "avatar") {
            url = "/update_avatar";
        } else if (endpoint == "bio" || endpoint == "displayname") {
            url = "/update_bio";
        } else if (endpoint == "deleteGal") {
			url = "/delete_gal";
        } else {
			throw new Error("Unexpected endpoint in formSubmit: " + endpoint);
        }
        let request = new XMLHttpRequest();
        request.open('POST', url, true);
        request.onreadystatechange = function() {
            if (request.readyState == 4) {
                if (request.status >= 200 && request.status <= 201) {
                    if (endpoint=="avatar") {
						pfp.src = JSON.parse(request.response).url;
					} else if (endpoint == "deleteGal") {
						let id = currentGal.Id;
						let thumb = document.getElementById("photo"+id);
						thumb.remove();
						macy.recalculate(true);
						toggleModal(undefined);
					}
                } else {
                    alert("Message failed to send to server. Status: " + request.status);
                }
            }
        };

        request.onerror = function() {
        // request failed
            alert("Image failed to send to server. No more information available.");
        };

        if (sourceForm != undefined) {
			let fd = new FormData(sourceForm); // create FormData using values from a <form> identified by sourceForm
			console.log(fd);
			request.send(fd);
        } else { //when the source form is undefined, it means its not taking data from an existing HTML form. IE a simple change like updating bio or displayname
            let fd = new FormData();
            fd.append("feature", endpoint)
            fd.append("text", document.getElementById(endpoint+"-modifier").value);
            request.send(fd);
        }
    }

	function toggleBioModifier(type) {
        let modifier, text
        if (type == "bio") {
			modifier = document.getElementById("bio-modifier")
			text = document.getElementById("bio-text")
		} else if (type == "displayname") {
			modifier = document.getElementById("displayname-modifier")
			text = document.getElementById("displayname-text")
		} else {
			throw new Error("Unknown endpoint for profile update. Use bio or displayname, not: " + type);
		}
        let disp = text.style.display;
        if (disp === "none") {
            text.style.display = "table";
            modifier.style.display = "none";
        } else {
            text.style.display = "none";
            modifier.style.display = "table";
        }
    }

    //validate and POST if necessary
    //type - bio or displayname
    function updateBio(type) { //validate and then POST if necessary (dont need to send a post if theres no change!)
		let modifier, text;
		if (type == "bio") {
			modifier = document.getElementById("bio-modifier")
			text = document.getElementById("bio-text")
		} else if (type == "displayname") {
			modifier = document.getElementById("displayname-modifier")
			text = document.getElementById("displayname-text")
		} else {
			throw new Error("Unknown endpoint for profile update. Use bio or displayname, not: " + type);
		}
        if (text.textContent != modifier.value) {
            formSubmit(undefined, type);
            text.textContent = modifier.value;
        }

        toggleBioModifier(type);
    }

	let pfp = document.getElementById("pfp");
	let pfpformc = document.getElementById("pfp-form-container");
	let pfpform = document.getElementById("pfp-form");

	pfpform.addEventListener("submit", (event) => {
		event.preventDefault();
		formSubmit(event.target, "avatar");
	});

	let deleteDialog = document.getElementById("delete-dialog");

	deleteDialog.addEventListener("close", (e) => {
		if (deleteDialog.returnValue === "confirm") {
			let dgi = document.getElementById("delete-gallery-id");
			dgi.value = currentGal.Id;
			formSubmit(deleteDialog.children[0], "deleteGal");
		}
	})
{{end}}

let currentGal = undefined;
let currentSlide = 0;
function toggleModal(gallery) {
	let lbox = document.getElementById("lbox");
	currentGal = gallery;
	if (gallery === undefined) {
		lbox.style.display = "none";
	} else {
		lbox.style.display = "block";
		let navs = document.getElementById("navigation-controls");
		if (gallery.Photos.length == 1) {
			navs.style.display = "none";
		} else {
			navs.style.display = "flex";
		}
		let desc = document.getElementById("gallery-description");
		let upload = document.getElementById("gallery-upload-stamp");
		desc.innerHTML = gallery.Description;
		upload.innerHTML = "Uploaded on " + gallery.Uploaded;
		currentSlide = 0;
		changeSlide(currentSlide);
	}
}

function changeSlide(n) {
	let maxSlides = currentGal.Photos.length;
	console.log(currentSlide, currentSlide+n);
	if (currentSlide+n <= maxSlides-1 && currentSlide+n >= 0) {
		currentSlide = currentSlide + n;
		let pc = document.getElementById("photo");
		let photo = currentGal.Photos[currentSlide];
		pc.src = photo.Reference;
		let exif = document.getElementById("img-exif");
		while (exif.firstChild) {
			exif.removeChild(exif.firstChild);
		}
		for (key in photo.Exif) {
			if (photo.Exif[key] != "") {
				let row = exif.insertRow();
				let c1 = row.insertCell(key);
				let c2 = row.insertCell();
				c1.innerHTML = key;
				c2.innerHTML = photo.Exif[key];
			}
		}
	}
}

window.onclick = function(event) {
	let cname = event.target.className;
	let id = event.target.id;
	console.log(cname, id);
	if (cname == "lbox" && id != "pfp-form-container") {
		event.preventDefault();
		let n = id.match(/lbox-(\d+)/)[1];
		toggleModal(n);
	}
	{{if $SU}}
	if (id == "pfp" || id == "pfp-form-container" || id == "pfp-form") {
		pfpformc.showModal();
	}
	if (id == "deleteGallery") {
		deleteDialog.showModal();
	}
	{{end}}
}
</script>
<script>
	//Macy performs poorly at edge cases where user has less photos than columns.
	//It also performs poorly when images are not massive enough to fill column widths. which isn't really an edge case imo.
	//There are a few ways to handle this but none of them look great. Going to ignore this for now since this is just an example site :D Long term solution would be to fork Macy.
	if (gals.length <= 3) {
		let sheet = window.document.styleSheets[0];
		sheet.insertRule("#macy-container {display: flex; justify-content: center}");
	} else {
		const macy = Macy({
			container: "#macy-container",
			trueOrder: true,
			waitForImages: true,
			columns: 3,
			margin: {
				x: 20,
				y: 20,
			},
		})
	}
</script>
{{end}}
